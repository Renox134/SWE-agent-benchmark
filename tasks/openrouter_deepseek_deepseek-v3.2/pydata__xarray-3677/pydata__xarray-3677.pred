{"model_name_or_path": "openrouter_deepseek_deepseek-v3.2", "instance_id": "pydata__xarray-3677", "model_patch": "diff --git a/reproduce_error.py b/reproduce_error.py\nnew file mode 100644\nindex 00000000..fce37aa6\n--- /dev/null\n+++ b/reproduce_error.py\n@@ -0,0 +1,17 @@\n+import xarray as xr\n+\n+ds = xr.Dataset({'a': 0})\n+da = xr.DataArray(1, name='b')\n+\n+print(\"Testing xr.merge([ds, da]):\")\n+expected = xr.merge([ds, da])  # works fine\n+print(expected)\n+print()\n+\n+print(\"Testing ds.merge(da):\")\n+try:\n+    actual = ds.merge(da)  # fails\n+    print(\"Success!\")\n+    print(actual)\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_consistency.py b/test_consistency.py\nnew file mode 100644\nindex 00000000..d2024bc5\n--- /dev/null\n+++ b/test_consistency.py\n@@ -0,0 +1,77 @@\n+import xarray as xr\n+import numpy as np\n+\n+print(\"Test consistency between xr.merge and ds.merge for DataArrays\")\n+\n+# Test 1: Simple case\n+ds = xr.Dataset({'a': 0})\n+da = xr.DataArray(1, name='b')\n+\n+result1 = xr.merge([ds, da])\n+result2 = ds.merge(da)\n+\n+print(\"Test 1 - Simple case:\")\n+print(\"xr.merge([ds, da]):\", result1)\n+print(\"ds.merge(da):\", result2)\n+print(\"Are they equal?\", result1.equals(result2))\n+print()\n+\n+# Test 2: With dimensions\n+ds2 = xr.Dataset({'a': ('x', [1, 2, 3])})\n+da2 = xr.DataArray([4, 5, 6], dims=['x'], name='b')\n+\n+result3 = xr.merge([ds2, da2])\n+result4 = ds2.merge(da2)\n+\n+print(\"Test 2 - With dimensions:\")\n+print(\"xr.merge([ds2, da2]):\", result3)\n+print(\"ds2.merge(da2):\", result4)\n+print(\"Are they equal?\", result3.equals(result4))\n+print()\n+\n+# Test 3: With coordinates\n+ds3 = xr.Dataset({'a': ('x', [1, 2, 3]), 'x': [0, 1, 2]})\n+da3 = xr.DataArray([4, 5, 6], dims=['x'], coords={'x': [0, 1, 2], 'y': ('x', [7, 8, 9])}, name='b')\n+\n+result5 = xr.merge([ds3, da3])\n+result6 = ds3.merge(da3)\n+\n+print(\"Test 3 - With coordinates:\")\n+print(\"xr.merge([ds3, da3]):\", result5)\n+print(\"ds3.merge(da3):\", result6)\n+print(\"Are they equal?\", result5.equals(result6))\n+print()\n+\n+# Test 4: With overwrite_vars\n+ds4 = xr.Dataset({'a': 0, 'b': 1})\n+da4 = xr.DataArray(2, name='b')\n+\n+# Note: xr.merge doesn't support overwrite_vars, so we need to test differently\n+print(\"Test 4 - With overwrite_vars:\")\n+print(\"ds4.merge(da4, overwrite_vars='b'):\", ds4.merge(da4, overwrite_vars='b'))\n+print()\n+\n+# Test 5: Multiple DataArrays\n+ds5 = xr.Dataset({'a': 0})\n+da5a = xr.DataArray(1, name='b')\n+da5b = xr.DataArray(2, name='c')\n+\n+result7 = xr.merge([ds5, da5a, da5b])\n+result8 = ds5.merge(da5a).merge(da5b)\n+\n+print(\"Test 5 - Multiple DataArrays:\")\n+print(\"xr.merge([ds5, da5a, da5b]):\", result7)\n+print(\"ds5.merge(da5a).merge(da5b):\", result8)\n+print(\"Are they equal?\", result7.equals(result8))\n+print()\n+\n+# Test 6: update method\n+ds6 = xr.Dataset({'a': 0, 'b': 1})\n+da6 = xr.DataArray(2, name='b')\n+\n+print(\"Test 6 - Update method:\")\n+ds6_copy = ds6.copy()\n+ds6_copy.update(da6)\n+print(\"ds6.update(da6):\", ds6_copy)\n+print(\"Should be same as merge with overwrite_vars='b':\", ds6.merge(da6, overwrite_vars='b'))\n+print(\"Are they equal?\", ds6_copy.equals(ds6.merge(da6, overwrite_vars='b')))\n\\ No newline at end of file\ndiff --git a/test_dataarray_merge.py b/test_dataarray_merge.py\nnew file mode 100644\nindex 00000000..a87b15ef\n--- /dev/null\n+++ b/test_dataarray_merge.py\n@@ -0,0 +1,61 @@\n+import xarray as xr\n+\n+# Test 1: Basic DataArray merge with dataset.merge()\n+print(\"Test 1: Basic DataArray merge with dataset.merge()\")\n+ds = xr.Dataset({'a': 0})\n+da = xr.DataArray(1, name='b')\n+\n+print(\"Testing xr.merge([ds, da]):\")\n+expected = xr.merge([ds, da])  # works fine\n+print(expected)\n+print()\n+\n+print(\"Testing ds.merge(da):\")\n+try:\n+    actual = ds.merge(da)  # fails\n+    print(\"Success!\")\n+    print(actual)\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+print()\n+\n+# Test 2: DataArray with dimensions\n+print(\"\\nTest 2: DataArray with dimensions\")\n+ds2 = xr.Dataset({'a': ('x', [1, 2, 3])})\n+da2 = xr.DataArray([4, 5, 6], dims=['x'], name='b')\n+\n+print(\"Testing xr.merge([ds2, da2]):\")\n+expected2 = xr.merge([ds2, da2])\n+print(expected2)\n+print()\n+\n+print(\"Testing ds2.merge(da2):\")\n+try:\n+    actual2 = ds2.merge(da2)\n+    print(\"Success!\")\n+    print(actual2)\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+print()\n+\n+# Test 3: DataArray without name\n+print(\"\\nTest 3: DataArray without name\")\n+ds3 = xr.Dataset({'a': 0})\n+da3 = xr.DataArray(1)  # No name\n+\n+print(\"Testing xr.merge([ds3, da3]):\")\n+try:\n+    expected3 = xr.merge([ds3, da3])\n+    print(\"Success!\")\n+    print(expected3)\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+print()\n+\n+print(\"Testing ds3.merge(da3):\")\n+try:\n+    actual3 = ds3.merge(da3)\n+    print(\"Success!\")\n+    print(actual3)\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_dict_with_dataarray.py b/test_dict_with_dataarray.py\nnew file mode 100644\nindex 00000000..fff54fed\n--- /dev/null\n+++ b/test_dict_with_dataarray.py\n@@ -0,0 +1,50 @@\n+import xarray as xr\n+\n+print(\"Test dict with DataArray values in update method\")\n+\n+# Test 1: dict with DataArray value\n+ds1 = xr.Dataset({'a': 0})\n+da1 = xr.DataArray(1, name='b')\n+\n+print(\"Test 1: dict with DataArray\")\n+print(\"ds1:\", ds1)\n+print(\"dict with da1:\", {'b': da1})\n+result1 = ds1.update({'b': da1})\n+print(\"ds1.update({'b': da1}):\", result1)\n+print()\n+\n+# Test 2: dict with multiple DataArrays\n+ds2 = xr.Dataset({'a': 0})\n+da2a = xr.DataArray(1, name='b')\n+da2b = xr.DataArray(2, name='c')\n+\n+print(\"Test 2: dict with multiple DataArrays\")\n+result2 = ds2.update({'b': da2a, 'c': da2b})\n+print(\"ds2.update({'b': da2a, 'c': da2b}):\", result2)\n+print()\n+\n+# Test 3: dict with DataArray that has conflicting coordinates\n+ds3 = xr.Dataset({'a': ('x', [1, 2, 3]), 'x': [0, 1, 2]})\n+da3 = xr.DataArray([4, 5, 6], dims=['x'], coords={'x': [0, 1, 2], 'y': ('x', [7, 8, 9])}, name='b')\n+\n+print(\"Test 3: DataArray with coordinates\")\n+print(\"ds3:\", ds3)\n+print(\"da3:\", da3)\n+result3 = ds3.update({'b': da3})\n+print(\"ds3.update({'b': da3}):\", result3)\n+print(\"Note: y coordinate should be added\")\n+print()\n+\n+# Test 4: dict with DataArray that has non-dimension coordinate that conflicts\n+ds4 = xr.Dataset({'a': ('x', [1, 2, 3]), 'x': [0, 1, 2], 'y': 10})\n+da4 = xr.DataArray([4, 5, 6], dims=['x'], coords={'x': [0, 1, 2], 'y': ('x', [7, 8, 9])}, name='b')\n+\n+print(\"Test 4: DataArray with conflicting non-dimension coordinate\")\n+print(\"ds4 has scalar coordinate y=10\")\n+print(\"da4 has coordinate y as data variable with shape (3,)\")\n+result4 = ds4.update({'b': da4})\n+print(\"ds4.update({'b': da4}):\", result4)\n+print(\"Note: y coordinate from da4 should be dropped (conflict)\")\n+print()\n+\n+print(\"All tests passed!\")\n\\ No newline at end of file\ndiff --git a/test_edge_cases.py b/test_edge_cases.py\nnew file mode 100644\nindex 00000000..26b56826\n--- /dev/null\n+++ b/test_edge_cases.py\n@@ -0,0 +1,88 @@\n+import xarray as xr\n+import numpy as np\n+\n+print(\"Test 1: DataArray with coordinates\")\n+ds = xr.Dataset({'a': ('x', [1, 2, 3]), 'x': [0, 1, 2]})\n+da = xr.DataArray([4, 5, 6], dims=['x'], coords={'x': [0, 1, 2], 'y': ('x', [7, 8, 9])}, name='b')\n+\n+print(\"ds:\", ds)\n+print(\"da:\", da)\n+print()\n+\n+print(\"Testing ds.merge(da):\")\n+result = ds.merge(da)\n+print(result)\n+print()\n+\n+print(\"Test 2: DataArray with overwrite_vars\")\n+ds2 = xr.Dataset({'a': 0, 'b': 1})\n+da2 = xr.DataArray(2, name='b')\n+\n+print(\"ds2:\", ds2)\n+print(\"da2:\", da2)\n+print()\n+\n+print(\"Testing ds2.merge(da2, overwrite_vars='b'):\")\n+result2 = ds2.merge(da2, overwrite_vars='b')\n+print(result2)\n+print()\n+\n+print(\"Test 3: DataArray with overwrite_vars as set\")\n+ds3 = xr.Dataset({'a': 0, 'b': 1, 'c': 2})\n+da3 = xr.DataArray(3, name='b')\n+\n+print(\"Testing ds3.merge(da3, overwrite_vars={'b'}):\")\n+result3 = ds3.merge(da3, overwrite_vars={'b'})\n+print(result3)\n+print()\n+\n+print(\"Test 4: DataArray with multiple overwrite_vars\")\n+ds4 = xr.Dataset({'a': 0, 'b': 1, 'c': 2})\n+da4 = xr.DataArray(3, name='b')\n+\n+print(\"Testing ds4.merge(da4, overwrite_vars=['b', 'c']):\")\n+try:\n+    result4 = ds4.merge(da4, overwrite_vars=['b', 'c'])\n+    print(result4)\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+print()\n+\n+print(\"Test 5: DataArray update\")\n+ds5 = xr.Dataset({'a': 0, 'b': 1})\n+da5 = xr.DataArray(2, name='b')\n+\n+print(\"Testing ds5.update(da5):\")\n+ds5_copy = ds5.copy()\n+ds5_copy.update(da5)\n+print(ds5_copy)\n+print()\n+\n+print(\"Test 6: Unnamed DataArray should fail\")\n+ds6 = xr.Dataset({'a': 0})\n+da6 = xr.DataArray(1)  # No name\n+\n+print(\"Testing ds6.merge(da6):\")\n+try:\n+    result6 = ds6.merge(da6)\n+    print(result6)\n+except ValueError as e:\n+    print(f\"Expected ValueError: {e}\")\n+print()\n+\n+print(\"Test 7: DataArray with compat='identical'\")\n+ds7 = xr.Dataset({'a': 0})\n+da7 = xr.DataArray(1, name='b')\n+\n+print(\"Testing ds7.merge(da7, compat='identical'):\")\n+result7 = ds7.merge(da7, compat='identical')\n+print(result7)\n+print()\n+\n+print(\"Test 8: DataArray with join='inner' on overlapping dimensions\")\n+ds8 = xr.Dataset({'a': ('x', [1, 2, 3]), 'x': [0, 1, 2]})\n+da8 = xr.DataArray([4, 5], dims=['x'], coords={'x': [1, 2]}, name='b')\n+\n+print(\"Testing ds8.merge(da8, join='inner'):\")\n+result8 = ds8.merge(da8, join='inner')\n+print(result8)\n\\ No newline at end of file\ndiff --git a/test_overwrite_vars.py b/test_overwrite_vars.py\nnew file mode 100644\nindex 00000000..a7b1d2d1\n--- /dev/null\n+++ b/test_overwrite_vars.py\n@@ -0,0 +1,70 @@\n+import xarray as xr\n+\n+print(\"Test overwrite_vars with DataArray\")\n+\n+# Test 1: overwrite_vars matches DataArray name\n+ds1 = xr.Dataset({'a': 0, 'b': 1})\n+da1 = xr.DataArray(2, name='b')\n+\n+print(\"Test 1: overwrite_vars='b' (matches DataArray name)\")\n+print(\"ds1:\", ds1)\n+print(\"da1:\", da1)\n+result1 = ds1.merge(da1, overwrite_vars='b')\n+print(\"ds1.merge(da1, overwrite_vars='b'):\", result1)\n+print(\"Expected: b should be 2\")\n+assert result1['b'].values == 2\n+print()\n+\n+# Test 2: overwrite_vars doesn't match DataArray name\n+ds2 = xr.Dataset({'a': 0, 'b': 1})\n+da2 = xr.DataArray(2, name='c')\n+\n+print(\"Test 2: overwrite_vars='b' (doesn't match DataArray name 'c')\")\n+print(\"ds2:\", ds2)\n+print(\"da2:\", da2)\n+result2 = ds2.merge(da2, overwrite_vars='b')\n+print(\"ds2.merge(da2, overwrite_vars='b'):\", result2)\n+print(\"Expected: b should be 1 (not overwritten), c should be 2\")\n+assert result2['b'].values == 1\n+assert result2['c'].values == 2\n+print()\n+\n+# Test 3: overwrite_vars is empty set\n+ds3 = xr.Dataset({'a': 0, 'b': 1})\n+da3 = xr.DataArray(2, name='c')\n+\n+print(\"Test 3: overwrite_vars=set()\")\n+result3 = ds3.merge(da3, overwrite_vars=set())\n+print(\"ds3.merge(da3, overwrite_vars=set()):\", result3)\n+print(\"Expected: a=0, b=1, c=2\")\n+assert result3['a'].values == 0\n+assert result3['b'].values == 1\n+assert result3['c'].values == 2\n+print()\n+\n+# Test 4: overwrite_vars is list with DataArray name\n+ds4 = xr.Dataset({'a': 0, 'b': 1, 'c': 3})\n+da4 = xr.DataArray(2, name='b')\n+\n+print(\"Test 4: overwrite_vars=['b', 'c']\")\n+result4 = ds4.merge(da4, overwrite_vars=['b', 'c'])\n+print(\"ds4.merge(da4, overwrite_vars=['b', 'c']):\", result4)\n+print(\"Expected: a=0, b=2 (overwritten), c=3 (not in DataArray, so stays)\")\n+assert result4['a'].values == 0\n+assert result4['b'].values == 2\n+assert result4['c'].values == 3\n+print()\n+\n+# Test 5: overwrite_vars contains name not in dataset\n+ds5 = xr.Dataset({'a': 0})\n+da5 = xr.DataArray(1, name='b')\n+\n+print(\"Test 5: overwrite_vars='c' (not in dataset or DataArray)\")\n+try:\n+    result5 = ds5.merge(da5, overwrite_vars='c')\n+    print(\"ds5.merge(da5, overwrite_vars='c'):\", result5)\n+except Exception as e:\n+    print(f\"Expected error: {type(e).__name__}: {e}\")\n+print()\n+\n+print(\"All tests passed!\")\n\\ No newline at end of file\ndiff --git a/test_update.py b/test_update.py\nnew file mode 100644\nindex 00000000..fa6c7fe6\n--- /dev/null\n+++ b/test_update.py\n@@ -0,0 +1,12 @@\n+import xarray as xr\n+\n+ds = xr.Dataset({'a': 0})\n+da = xr.DataArray(1, name='b')\n+\n+print(\"Testing ds.update(da):\")\n+try:\n+    ds.update(da)\n+    print(\"Success!\")\n+    print(ds)\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/xarray/core/dataset.py b/xarray/core/dataset.py\nindex ac0a923d..fe700e7b 100644\n--- a/xarray/core/dataset.py\n+++ b/xarray/core/dataset.py\n@@ -3515,7 +3515,7 @@ class Dataset(Mapping, ImplementsDatasetReduce, DataWithCoords):\n             result = result._unstack_once(dim, fill_value, sparse)\n         return result\n \n-    def update(self, other: \"CoercibleMapping\", inplace: bool = None) -> \"Dataset\":\n+    def update(self, other: Union[\"DataArray\", \"CoercibleMapping\"], inplace: bool = None) -> \"Dataset\":\n         \"\"\"Update this dataset's variables with those from another dataset.\n \n         Parameters\n@@ -3547,7 +3547,7 @@ class Dataset(Mapping, ImplementsDatasetReduce, DataWithCoords):\n \n     def merge(\n         self,\n-        other: \"CoercibleMapping\",\n+        other: Union[\"DataArray\", \"CoercibleMapping\"],\n         inplace: bool = None,\n         overwrite_vars: Union[Hashable, Iterable[Hashable]] = frozenset(),\n         compat: str = \"no_conflicts\",\ndiff --git a/xarray/core/merge.py b/xarray/core/merge.py\nindex 10c7804d..380ac74b 100644\n--- a/xarray/core/merge.py\n+++ b/xarray/core/merge.py\n@@ -797,7 +797,7 @@ def merge(\n \n def dataset_merge_method(\n     dataset: \"Dataset\",\n-    other: \"CoercibleMapping\",\n+    other: Union[\"DataArray\", \"CoercibleMapping\"],\n     overwrite_vars: Union[Hashable, Iterable[Hashable]],\n     compat: str,\n     join: str,\n@@ -805,6 +805,8 @@ def dataset_merge_method(\n ) -> _MergeResult:\n     \"\"\"Guts of the Dataset.merge method.\n     \"\"\"\n+    from .dataarray import DataArray\n+    \n     # we are locked into supporting overwrite_vars for the Dataset.merge\n     # method due for backwards compatibility\n     # TODO: consider deprecating it?\n@@ -814,6 +816,10 @@ def dataset_merge_method(\n     else:\n         overwrite_vars = {overwrite_vars}\n \n+    # Convert DataArray to Dataset for compatibility with merge_core\n+    if isinstance(other, DataArray):\n+        other = other.to_dataset()\n+\n     if not overwrite_vars:\n         objs = [dataset, other]\n         priority_arg = None\n@@ -837,7 +843,7 @@ def dataset_merge_method(\n \n \n def dataset_update_method(\n-    dataset: \"Dataset\", other: \"CoercibleMapping\"\n+    dataset: \"Dataset\", other: Union[\"DataArray\", \"CoercibleMapping\"]\n ) -> _MergeResult:\n     \"\"\"Guts of the Dataset.update method.\n \n@@ -848,6 +854,10 @@ def dataset_update_method(\n     from .dataarray import DataArray\n     from .dataset import Dataset\n \n+    # Convert DataArray to Dataset for compatibility\n+    if isinstance(other, DataArray):\n+        other = other.to_dataset()\n+    \n     if not isinstance(other, Dataset):\n         other = dict(other)\n         for key, value in other.items():\n"}