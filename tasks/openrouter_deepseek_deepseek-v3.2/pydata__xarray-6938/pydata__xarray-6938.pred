{"model_name_or_path": "openrouter_deepseek_deepseek-v3.2", "instance_id": "pydata__xarray-6938", "model_patch": "diff --git a/debug_swap.py b/debug_swap.py\nnew file mode 100644\nindex 00000000..f3669662\n--- /dev/null\n+++ b/debug_swap.py\n@@ -0,0 +1,56 @@\n+import numpy as np\n+import xarray as xr\n+\n+nz = 11\n+ds = xr.Dataset(\n+    data_vars={\n+        \"y\": (\"z\", np.random.rand(nz)),\n+        \"lev\": (\"z\", np.arange(nz) * 10),\n+        # ^ We want this to be a dimension coordinate\n+    },\n+)\n+\n+print(\"Original ds:\")\n+print(f\"ds['lev'].dims: {ds['lev'].dims}\")\n+print(f\"ds['lev'] is IndexVariable: {isinstance(ds['lev'], xr.IndexVariable)}\")\n+print(f\"id(ds['lev']): {id(ds['lev'])}\")\n+\n+# First swap\n+swapped = ds.swap_dims(z='lev')\n+print(\"\\nAfter first swap_dims:\")\n+print(f\"swapped['lev'].dims: {swapped['lev'].dims}\")\n+print(f\"swapped['lev'] is IndexVariable: {isinstance(swapped['lev'], xr.IndexVariable)}\")\n+print(f\"id(swapped['lev']): {id(swapped['lev'])}\")\n+\n+# Create ds2\n+ds2 = (\n+    ds.swap_dims(z=\"lev\")\n+    .rename_dims(lev=\"z\")\n+    .reset_index(\"lev\")\n+    .reset_coords()\n+)\n+print(\"\\nds2 after creation:\")\n+print(f\"ds2['lev'].dims: {ds2['lev'].dims}\")\n+print(f\"ds2['lev'] is IndexVariable: {isinstance(ds2['lev'], xr.IndexVariable)}\")\n+print(f\"id(ds2['lev']): {id(ds2['lev'])}\")\n+\n+# Check if ds2['lev'] is the same object as ds['lev']\n+print(f\"\\nds2['lev'] is ds['lev']: {ds2['lev'] is ds['lev']}\")\n+\n+# Now apply swap_dims to ds2\n+print(\"\\nApplying swap_dims to ds2...\")\n+swapped2 = ds2.swap_dims(z='lev')\n+print(f\"swapped2['lev'].dims: {swapped2['lev'].dims}\")\n+print(f\"swapped2['lev'] is IndexVariable: {isinstance(swapped2['lev'], xr.IndexVariable)}\")\n+\n+# Check ds2 after swap\n+print(\"\\nds2 after swap_dims applied:\")\n+print(f\"ds2['lev'].dims: {ds2['lev'].dims}\")\n+print(f\"ds2['lev'] is IndexVariable: {isinstance(ds2['lev'], xr.IndexVariable)}\")\n+\n+# Let's trace through what happens in swap_dims\n+print(\"\\n--- Debugging swap_dims internals ---\")\n+print(f\"ds2.dims: {ds2.dims}\")\n+print(f\"ds2.variables['lev'].dims: {ds2.variables['lev'].dims}\")\n+print(f\"ds2._coord_names: {ds2._coord_names}\")\n+print(f\"'lev' in ds2._coord_names: {'lev' in ds2._coord_names}\")\n\\ No newline at end of file\ndiff --git a/debug_variable.py b/debug_variable.py\nnew file mode 100644\nindex 00000000..3efb9cbb\n--- /dev/null\n+++ b/debug_variable.py\n@@ -0,0 +1,63 @@\n+import numpy as np\n+import xarray as xr\n+\n+nz = 11\n+ds = xr.Dataset(\n+    data_vars={\n+        \"y\": (\"z\", np.random.rand(nz)),\n+        \"lev\": (\"z\", np.arange(nz) * 10),\n+        # ^ We want this to be a dimension coordinate\n+    },\n+)\n+\n+# Create ds2\n+ds2 = (\n+    ds.swap_dims(z=\"lev\")\n+    .rename_dims(lev=\"z\")\n+    .reset_index(\"lev\")\n+    .reset_coords()\n+)\n+\n+print(\"Before swap_dims:\")\n+print(f\"ds2['lev'].dims: {ds2['lev'].dims}\")\n+print(f\"id(ds2['lev']): {id(ds2['lev'])}\")\n+print(f\"id(ds2.variables['lev']): {id(ds2.variables['lev'])}\")\n+\n+# Let's manually trace through what swap_dims does\n+print(\"\\n--- Manual trace of swap_dims logic ---\")\n+dims_dict = {\"z\": \"lev\"}\n+result_dims = {dims_dict.get(dim, dim) for dim in ds2.dims}\n+print(f\"result_dims: {result_dims}\")\n+print(f\"'lev' in result_dims: {'lev' in result_dims}\")\n+\n+# Check what happens for variable 'lev'\n+v = ds2.variables['lev']\n+print(f\"\\nFor variable 'lev':\")\n+print(f\"v.dims: {v.dims}\")\n+print(f\"id(v): {id(v)}\")\n+dims = tuple(dims_dict.get(dim, dim) for dim in v.dims)\n+print(f\"new dims: {dims}\")\n+\n+# Check if 'lev' is in result_dims\n+if 'lev' in result_dims:\n+    print(\"'lev' is in result_dims, so it will be converted to IndexVariable\")\n+    var = v.to_index_variable()\n+    print(f\"After to_index_variable(): id(var): {id(var)}\")\n+    print(f\"var is v: {var is v}\")\n+    var.dims = dims\n+    print(f\"After setting dims: var.dims: {var.dims}\")\n+    print(f\"v.dims after modifying var: {v.dims}\")\n+else:\n+    print(\"'lev' is NOT in result_dims, so it will be converted to base variable\")\n+    var = v.to_base_variable()\n+    print(f\"After to_base_variable(): id(var): {id(var)}\")\n+    print(f\"var is v: {var is v}\")\n+    var.dims = dims\n+    print(f\"After setting dims: var.dims: {var.dims}\")\n+    print(f\"v.dims after modifying var: {v.dims}\")\n+\n+print(\"\\n--- Now actually run swap_dims ---\")\n+swapped = ds2.swap_dims(z='lev')\n+print(f\"After swap_dims:\")\n+print(f\"ds2['lev'].dims: {ds2['lev'].dims}\")\n+print(f\"swapped['lev'].dims: {swapped['lev'].dims}\")\n\\ No newline at end of file\ndiff --git a/reproduce_issue.py b/reproduce_issue.py\nnew file mode 100644\nindex 00000000..8133e623\n--- /dev/null\n+++ b/reproduce_issue.py\n@@ -0,0 +1,31 @@\n+import numpy as np\n+import xarray as xr\n+\n+nz = 11\n+ds = xr.Dataset(\n+    data_vars={\n+        \"y\": (\"z\", np.random.rand(nz)),\n+        \"lev\": (\"z\", np.arange(nz) * 10),\n+        # ^ We want this to be a dimension coordinate\n+    },\n+)\n+print(f\"ds\\n{ds}\")\n+print(f\"\\nds, 'lev' -> dim coord\\n{ds.swap_dims(z='lev')}\")\n+\n+ds2 = (\n+    ds.swap_dims(z=\"lev\")\n+    .rename_dims(lev=\"z\")\n+    .reset_index(\"lev\")\n+    .reset_coords()\n+)\n+print(f\"\\nds2\\n{ds2}\")\n+# ^ This Dataset appears same as the original\n+\n+print(f\"\\nds2, 'lev' -> dim coord\\n{ds2.swap_dims(z='lev')}\")\n+# ^ Produces a Dataset with dimension coordinate 'lev'\n+print(f\"\\nds2 after .swap_dims() applied\\n{ds2}\")\n+# ^ `ds2['lev']` now has dimension 'lev' although otherwise same\n+\n+# Let's check if ds2['lev'] was modified\n+print(f\"\\nChecking ds2['lev'].dims before swap: {ds2['lev'].dims}\")\n+print(f\"Checking ds2['lev'] is IndexVariable: {isinstance(ds2['lev'], xr.IndexVariable)}\")\n\\ No newline at end of file\n"}