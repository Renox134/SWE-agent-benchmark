{"model_name_or_path": "openrouter_deepseek_deepseek-v3.2", "instance_id": "psf__requests-2931", "model_patch": "diff --git a/debug_flow.py b/debug_flow.py\nnew file mode 100644\nindex 0000000..89b5e49\n--- /dev/null\n+++ b/debug_flow.py\n@@ -0,0 +1,59 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+import sys\n+\n+# Monkey patch to_native_string to see what's happening\n+import requests.utils\n+original_to_native_string = requests.utils.to_native_string\n+\n+def debug_to_native_string(string, encoding='ascii'):\n+    print(f\"DEBUG to_native_string called with:\")\n+    print(f\"  Type: {type(string)}\")\n+    print(f\"  Value: {repr(string)}\")\n+    print(f\"  Encoding: {encoding}\")\n+    try:\n+        result = original_to_native_string(string, encoding)\n+        print(f\"  Result: {repr(result)}\")\n+        return result\n+    except Exception as e:\n+        print(f\"  ERROR: {type(e).__name__}: {e}\")\n+        raise\n+\n+requests.utils.to_native_string = debug_to_native_string\n+\n+# Also patch _encode_params to see when it's called\n+import requests.models\n+original_encode_params = requests.models.RequestEncodingMixin._encode_params\n+\n+@staticmethod\n+def debug_encode_params(data):\n+    print(f\"\\nDEBUG _encode_params called with:\")\n+    print(f\"  Type: {type(data)}\")\n+    print(f\"  Value: {repr(data)}\")\n+    try:\n+        result = original_encode_params(data)\n+        print(f\"  Result: {repr(result)}\")\n+        return result\n+    except Exception as e:\n+        print(f\"  ERROR: {type(e).__name__}: {e}\")\n+        raise\n+\n+requests.models.RequestEncodingMixin._encode_params = debug_encode_params\n+\n+print(\"Test 1: Binary data in request body\")\n+print(\"=\" * 50)\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\"))\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 2: Params as bytes\")\n+print(\"=\" * 50)\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=foo\")\n+    print(f\"Success! Status: {response.status_code}\")\n+    print(f\"URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/reproduce_issue.py b/reproduce_issue.py\nnew file mode 100644\nindex 0000000..2ef27dc\n--- /dev/null\n+++ b/reproduce_issue.py\n@@ -0,0 +1,34 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+\n+# Test case from PR description\n+try:\n+    print(\"Testing: requests.put with binary data containing non-ASCII characters\")\n+    # This should fail with requests 2.9\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\"))\n+    print(\"Success! No error occurred.\")\n+except Exception as e:\n+    print(f\"Error occurred: {type(e).__name__}: {e}\")\n+\n+# Additional test cases\n+print(\"\\nTesting with ASCII-only binary data:\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=b\"hello world\")\n+    print(\"Success! No error occurred.\")\n+except Exception as e:\n+    print(f\"Error occurred: {type(e).__name__}: {e}\")\n+\n+print(\"\\nTesting with string data:\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=\"hello world\")\n+    print(\"Success! No error occurred.\")\n+except Exception as e:\n+    print(f\"Error occurred: {type(e).__name__}: {e}\")\n+\n+print(\"\\nTesting with unicode string:\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\")\n+    print(\"Success! No error occurred.\")\n+except Exception as e:\n+    print(f\"Error occurred: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/requests/models.py b/requests/models.py\nindex 9c624d3..1f1f1cf 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -80,8 +80,17 @@ class RequestEncodingMixin(object):\n         if parameters are supplied as a dict.\n         \"\"\"\n \n-        if isinstance(data, (str, bytes)):\n+        if isinstance(data, str):\n             return to_native_string(data)\n+        elif isinstance(data, bytes):\n+            # Try to decode bytes as UTF-8 first, then Latin-1 as fallback\n+            # Latin-1 can decode any byte, so this will never fail\n+            try:\n+                return data.decode('utf-8')\n+            except UnicodeDecodeError:\n+                # If UTF-8 fails, try Latin-1\n+                # Latin-1 can decode any byte, so this will always succeed\n+                return data.decode('latin-1')\n         elif hasattr(data, 'read'):\n             return data\n         elif hasattr(data, '__iter__'):\ndiff --git a/test_basic_auth.py b/test_basic_auth.py\nnew file mode 100644\nindex 0000000..d8bcf58\n--- /dev/null\n+++ b/test_basic_auth.py\n@@ -0,0 +1,28 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+from requests.auth import HTTPBasicAuth\n+\n+# Test basic auth with ASCII credentials\n+print(\"Test 1: Basic auth with ASCII credentials\")\n+try:\n+    response = requests.get(\"http://httpbin.org/basic-auth/user/passwd\", auth=HTTPBasicAuth('user', 'passwd'))\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test basic auth with non-ASCII credentials\n+print(\"\\nTest 2: Basic auth with non-ASCII credentials\")\n+try:\n+    response = requests.get(\"http://httpbin.org/basic-auth/user/passwd\", auth=HTTPBasicAuth('user', 'p\u00e4sswd'))\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test basic auth with non-ASCII username\n+print(\"\\nTest 3: Basic auth with non-ASCII username\")\n+try:\n+    response = requests.get(\"http://httpbin.org/basic-auth/user/passwd\", auth=HTTPBasicAuth('\u00fcs\u00e9r', 'passwd'))\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_binary_simple.py b/test_binary_simple.py\nnew file mode 100644\nindex 0000000..2339879\n--- /dev/null\n+++ b/test_binary_simple.py\n@@ -0,0 +1,44 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+import io\n+\n+# Test with binary data\n+print(\"Test with binary data:\")\n+binary_data = bytes([0x00, 0x01, 0x02, 0x80, 0x81, 0x82, 0xff])\n+print(f\"Original data (hex): {binary_data.hex()}\")\n+\n+# Create a simple test server\n+from http.server import HTTPServer, BaseHTTPRequestHandler\n+import threading\n+\n+class TestHandler(BaseHTTPRequestHandler):\n+    def do_PUT(self):\n+        content_length = int(self.headers['Content-Length'])\n+        body = self.rfile.read(content_length)\n+        self.send_response(200)\n+        self.send_header('Content-Type', 'text/plain')\n+        self.end_headers()\n+        self.wfile.write(f\"Received {len(body)} bytes: {body.hex()}\".encode())\n+    \n+    def log_message(self, format, *args):\n+        pass  # Suppress log messages\n+\n+server = HTTPServer(('localhost', 8888), TestHandler)\n+thread = threading.Thread(target=server.serve_forever)\n+thread.daemon = True\n+thread.start()\n+\n+try:\n+    response = requests.put(\"http://localhost:8888/\", data=binary_data)\n+    print(f\"Response: {response.text}\")\n+    \n+    # Check what was received\n+    if \"Received 7 bytes: 000102808182ff\" in response.text:\n+        print(\"Binary data preserved correctly!\")\n+    else:\n+        print(f\"Data changed! Response: {response.text}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+finally:\n+    server.shutdown()\n\\ No newline at end of file\ndiff --git a/test_comprehensive.py b/test_comprehensive.py\nnew file mode 100644\nindex 0000000..1c61ecf\n--- /dev/null\n+++ b/test_comprehensive.py\n@@ -0,0 +1,73 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+\n+test_cases = [\n+    # (description, callable, should_pass)\n+    (\"Original issue: UTF-8 bytes as data\", \n+     lambda: requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\")), True),\n+    \n+    (\"ASCII bytes as data\", \n+     lambda: requests.put(\"http://httpbin.org/put\", data=b\"hello\"), True),\n+     \n+    (\"String as data\", \n+     lambda: requests.put(\"http://httpbin.org/put\", data=\"hello\"), True),\n+     \n+    (\"Unicode string as data\", \n+     lambda: requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\"), True),\n+     \n+    (\"Params as ASCII bytes\", \n+     lambda: requests.get(\"http://httpbin.org/get\", params=b\"test=foo\"), True),\n+     \n+    (\"Params as UTF-8 bytes\", \n+     lambda: requests.get(\"http://httpbin.org/get\", params=b\"test=\\xc3\\xb6\\xc3\\xb6\\xc3\\xb6\"), True),\n+     \n+    (\"Params as Latin-1 bytes\", \n+     lambda: requests.get(\"http://httpbin.org/get\", params=\"caf\u00e9=caf\u00e9\".encode(\"latin-1\")), True),\n+     \n+    (\"Params as string\", \n+     lambda: requests.get(\"http://httpbin.org/get\", params=\"test=foo\"), True),\n+     \n+    (\"Form data as dict\", \n+     lambda: requests.post(\"http://httpbin.org/post\", data={\"key\": \"value\"}), True),\n+     \n+    (\"Form data as list of tuples\", \n+     lambda: requests.post(\"http://httpbin.org/post\", data=[(\"key\", \"value\")]), True),\n+     \n+    (\"Form data as bytes\", \n+     lambda: requests.post(\"http://httpbin.org/post\", data=b\"key=value&foo=bar\"), True),\n+     \n+    (\"Form data as string\", \n+     lambda: requests.post(\"http://httpbin.org/post\", data=\"key=value&foo=bar\"), True),\n+     \n+    (\"Binary data (non-UTF-8)\", \n+     lambda: requests.put(\"http://httpbin.org/put\", data=bytes([0x80, 0x81, 0x82])), True),\n+     \n+    (\"File-like object\", \n+     lambda: requests.put(\"http://httpbin.org/put\", data=open('/dev/null', 'rb')), True),\n+]\n+\n+all_passed = True\n+for description, test_func, should_pass in test_cases:\n+    print(f\"\\n{description}:\")\n+    try:\n+        response = test_func()\n+        if hasattr(response, 'status_code'):\n+            print(f\"  Success! Status: {response.status_code}\")\n+        else:\n+            print(f\"  Success!\")\n+        if not should_pass:\n+            print(f\"  ERROR: Should have failed but didn't!\")\n+            all_passed = False\n+    except Exception as e:\n+        if should_pass:\n+            print(f\"  ERROR: {type(e).__name__}: {e}\")\n+            all_passed = False\n+        else:\n+            print(f\"  Expected failure: {type(e).__name__}: {e}\")\n+\n+if all_passed:\n+    print(\"\\nAll tests passed!\")\n+else:\n+    print(\"\\nSome tests failed!\")\n+    exit(1)\n\\ No newline at end of file\ndiff --git a/test_detailed.py b/test_detailed.py\nnew file mode 100644\nindex 0000000..659a136\n--- /dev/null\n+++ b/test_detailed.py\n@@ -0,0 +1,54 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+\n+# Test 1: Binary data in request body (should work)\n+print(\"Test 1: Binary data in request body\")\n+try:\n+    # This is what the PR description shows failing\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\"))\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test 2: String data in request body (should work)\n+print(\"\\nTest 2: String data in request body\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=\"hello world\")\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test 3: Unicode string in request body (should work)\n+print(\"\\nTest 3: Unicode string in request body\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\")\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test 4: ASCII-only binary data in request body (should work)\n+print(\"\\nTest 4: ASCII-only binary data in request body\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=b\"hello world\")\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test 5: Params as bytes (should work - issue #2844)\n+print(\"\\nTest 5: Params as bytes\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=foo\")\n+    print(f\"Success! Status: {response.status_code}\")\n+    print(f\"URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test 6: Params as string (should work)\n+print(\"\\nTest 6: Params as string\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=\"test=foo\")\n+    print(f\"Success! Status: {response.status_code}\")\n+    print(f\"URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_edge_cases.py b/test_edge_cases.py\nnew file mode 100644\nindex 0000000..5f36ec2\n--- /dev/null\n+++ b/test_edge_cases.py\n@@ -0,0 +1,53 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+\n+# Test edge cases\n+print(\"Test 1: UTF-8 encoded bytes as data\")\n+try:\n+    # These are UTF-8 encoded bytes that represent text\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"Hello world\".encode(\"utf-8\"))\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\nTest 2: Non-UTF-8 bytes as data\")\n+try:\n+    # These bytes are not valid UTF-8\n+    response = requests.put(\"http://httpbin.org/put\", data=bytes([0x80, 0x81, 0x82]))\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\nTest 3: Latin-1 encoded bytes as data\")\n+try:\n+    # Latin-1 encoded bytes\n+    response = requests.put(\"http://httpbin.org/put\", data=\"caf\u00e9\".encode(\"latin-1\"))\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\nTest 4: Params as Latin-1 encoded bytes\")\n+try:\n+    # Latin-1 encoded bytes as params\n+    response = requests.get(\"http://httpbin.org/get\", params=\"caf\u00e9=caf\u00e9\".encode(\"latin-1\"))\n+    print(f\"Success! Status: {response.status_code}\")\n+    print(f\"URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\nTest 5: Headers with non-ASCII characters\")\n+try:\n+    # Headers should be ASCII, but let's test\n+    response = requests.get(\"http://httpbin.org/get\", headers={\"X-Test\": \"caf\u00e9\"})\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\nTest 6: Method with non-ASCII characters (should fail)\")\n+try:\n+    # HTTP method should be ASCII\n+    response = requests.request(\"G\u00c9T\", \"http://httpbin.org/get\")\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_final.py b/test_final.py\nnew file mode 100644\nindex 0000000..6a14ea3\n--- /dev/null\n+++ b/test_final.py\n@@ -0,0 +1,61 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+\n+# Test the exact example from the PR description\n+print(\"Test from PR description:\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\"))\n+    print(f\"Success! Status: {response.status_code}\")\n+    # Check that the data was sent correctly\n+    data = response.json()\n+    print(f\"Data sent: {data.get('data', '')}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test with other encodings\n+print(\"\\nTest with Latin-1 encoded bytes:\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=\"caf\u00e9\".encode(\"latin-1\"))\n+    print(f\"Success! Status: {response.status_code}\")\n+    data = response.json()\n+    print(f\"Data sent: {data.get('data', '')}\")\n+    print(f\"Data sent (hex): {data.get('data', '').encode('latin-1').hex()}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test with binary data\n+print(\"\\nTest with binary data:\")\n+try:\n+    binary_data = bytes([0x00, 0x01, 0x02, 0x80, 0x81, 0x82, 0xff])\n+    response = requests.put(\"http://httpbin.org/put\", data=binary_data)\n+    print(f\"Success! Status: {response.status_code}\")\n+    data = response.json()\n+    print(f\"Data sent (hex): {data.get('data', '').encode('latin-1').hex()}\")\n+    print(f\"Original data (hex): {binary_data.hex()}\")\n+    # Check that the data was sent correctly\n+    sent_data = data.get('data', '').encode('latin-1')\n+    if sent_data == binary_data:\n+        print(\"Data preserved correctly!\")\n+    else:\n+        print(f\"Data changed! Original: {binary_data.hex()}, Sent: {sent_data.hex()}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test params as bytes\n+print(\"\\nTest params as bytes:\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=foo\")\n+    print(f\"Success! Status: {response.status_code}\")\n+    print(f\"URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test params as UTF-8 bytes\n+print(\"\\nTest params as UTF-8 bytes:\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=\\xc3\\xb6\\xc3\\xb6\\xc3\\xb6\")\n+    print(f\"Success! Status: {response.status_code}\")\n+    print(f\"URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_fix.py b/test_fix.py\nnew file mode 100644\nindex 0000000..7e3c7c1\n--- /dev/null\n+++ b/test_fix.py\n@@ -0,0 +1,56 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+import sys\n+\n+# Test the current behavior\n+print(\"Testing current behavior:\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\"))\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Now let's test what happens if we change to_native_string to use 'utf-8' instead of 'ascii'\n+print(\"\\n\\nTesting with modified to_native_string:\")\n+import requests.utils\n+\n+original_to_native_string = requests.utils.to_native_string\n+\n+def patched_to_native_string(string, encoding='utf-8'):\n+    \"\"\"Patched version that uses utf-8 by default instead of ascii\"\"\"\n+    out = None\n+\n+    if isinstance(string, requests.compat.builtin_str):\n+        out = string\n+    else:\n+        if requests.compat.is_py2:\n+            out = string.encode(encoding)\n+        else:\n+            out = string.decode(encoding)\n+\n+    return out\n+\n+requests.utils.to_native_string = patched_to_native_string\n+\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\"))\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test params as bytes\n+print(\"\\n\\nTesting params as bytes with patched version:\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=foo\")\n+    print(f\"Success! URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test params as bytes with non-ASCII\n+print(\"\\n\\nTesting params as bytes with non-ASCII:\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=\\xc3\\xb6\\xc3\\xb6\\xc3\\xb6\")\n+    print(f\"Success! URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_fix2.py b/test_fix2.py\nnew file mode 100644\nindex 0000000..3f468d0\n--- /dev/null\n+++ b/test_fix2.py\n@@ -0,0 +1,48 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests.utils\n+import requests.models\n+\n+# Monkey patch to_native_string in the module where it's used\n+original_to_native_string = requests.utils.to_native_string\n+\n+def patched_to_native_string(string, encoding='utf-8'):\n+    \"\"\"Patched version that uses utf-8 by default instead of ascii\"\"\"\n+    out = None\n+\n+    if isinstance(string, requests.compat.builtin_str):\n+        out = string\n+    else:\n+        if requests.compat.is_py2:\n+            out = string.encode(encoding)\n+        else:\n+            out = string.decode(encoding)\n+\n+    return out\n+\n+# Patch it in both places\n+requests.utils.to_native_string = patched_to_native_string\n+requests.models.to_native_string = patched_to_native_string\n+\n+# Now test\n+print(\"Testing with patched to_native_string (utf-8 default):\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\"))\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTesting params as bytes with non-ASCII:\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=\\xc3\\xb6\\xc3\\xb6\\xc3\\xb6\")\n+    print(f\"Success! URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test with ASCII params\n+print(\"\\n\\nTesting params as bytes with ASCII:\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=foo\")\n+    print(f\"Success! URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_form_data.py b/test_form_data.py\nnew file mode 100644\nindex 0000000..2d5482f\n--- /dev/null\n+++ b/test_form_data.py\n@@ -0,0 +1,35 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+\n+# Test with form data (dict)\n+print(\"Test 1: Form data as dict\")\n+try:\n+    response = requests.post(\"http://httpbin.org/post\", data={\"key\": \"value\", \"test\": u\"\u00f6\u00f6\u00f6\"})\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test with form data (list of tuples)\n+print(\"\\nTest 2: Form data as list of tuples\")\n+try:\n+    response = requests.post(\"http://httpbin.org/post\", data=[(\"key\", \"value\"), (\"test\", u\"\u00f6\u00f6\u00f6\")])\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test with form data (bytes) - this should fail\n+print(\"\\nTest 3: Form data as bytes\")\n+try:\n+    response = requests.post(\"http://httpbin.org/post\", data=b\"key=value&test=\\xc3\\xb6\\xc3\\xb6\\xc3\\xb6\")\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+# Test with form data (string)\n+print(\"\\nTest 4: Form data as string\")\n+try:\n+    response = requests.post(\"http://httpbin.org/post\", data=\"key=value&test=\u00f6\u00f6\u00f6\")\n+    print(f\"Success! Status: {response.status_code}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_latin1.py b/test_latin1.py\nnew file mode 100644\nindex 0000000..df01a11\n--- /dev/null\n+++ b/test_latin1.py\n@@ -0,0 +1,24 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+\n+# Test Latin-1 encoded bytes\n+print(\"Test Latin-1 encoded bytes as params:\")\n+latin1_bytes = \"caf\u00e9=caf\u00e9\".encode(\"latin-1\")\n+print(f\"Latin-1 bytes: {latin1_bytes!r}\")\n+print(f\"Decoded as Latin-1: {latin1_bytes.decode('latin-1')!r}\")\n+print(f\"Decoded as UTF-8 (should fail): \", end=\"\")\n+try:\n+    print(latin1_bytes.decode('utf-8'))\n+except UnicodeDecodeError as e:\n+    print(f\"Error: {e}\")\n+\n+response = requests.get(\"http://httpbin.org/get\", params=latin1_bytes)\n+print(f\"URL: {response.url}\")\n+print(f\"Expected: caf\u00e9=caf\u00e9 encoded in the URL\")\n+print(f\"Actual: {response.url}\")\n+\n+# Check what was sent\n+if response.status_code == 200:\n+    data = response.json()\n+    print(f\"Args received: {data.get('args', {})}\")\n\\ No newline at end of file\ndiff --git a/test_no_decode.py b/test_no_decode.py\nnew file mode 100644\nindex 0000000..51f3e8d\n--- /dev/null\n+++ b/test_no_decode.py\n@@ -0,0 +1,69 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests.utils\n+import requests.models\n+\n+# Monkey patch _encode_params to return bytes as-is\n+original_encode_params = requests.models.RequestEncodingMixin._encode_params\n+\n+@staticmethod\n+def patched_encode_params(data):\n+    \"\"\"Patched version that returns bytes as-is\"\"\"\n+    if isinstance(data, bytes):\n+        # Return bytes as-is\n+        return data\n+    elif isinstance(data, str):\n+        return requests.utils.to_native_string(data)\n+    elif hasattr(data, 'read'):\n+        return data\n+    elif hasattr(data, '__iter__'):\n+        result = []\n+        for k, vs in requests.utils.to_key_val_list(data):\n+            if isinstance(vs, requests.compat.basestring) or not hasattr(vs, '__iter__'):\n+                vs = [vs]\n+            for v in vs:\n+                if v is not None:\n+                    result.append(\n+                        (k.encode('utf-8') if isinstance(k, str) else k,\n+                         v.encode('utf-8') if isinstance(v, str) else v))\n+        return requests.compat.urlencode(result, doseq=True)\n+    else:\n+        return data\n+\n+requests.models.RequestEncodingMixin._encode_params = patched_encode_params\n+\n+# Now test\n+print(\"Test 1: Binary data in request body\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\"))\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 2: Params as bytes\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=foo\")\n+    print(f\"Success! URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 3: Params as bytes with non-ASCII\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=\\xc3\\xb6\\xc3\\xb6\\xc3\\xb6\")\n+    print(f\"Success! URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 4: Form data as dict\")\n+try:\n+    response = requests.post(\"http://httpbin.org/post\", data={\"key\": \"value\"})\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 5: String data\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=\"hello\")\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_params_bytes.py b/test_params_bytes.py\nnew file mode 100644\nindex 0000000..7f06ce6\n--- /dev/null\n+++ b/test_params_bytes.py\n@@ -0,0 +1,33 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests\n+\n+# Test case from issue #2844\n+print(\"Testing params as bytes:\")\n+try:\n+    request = requests.Request('GET', 'http://example.com', params=b'test=foo').prepare()\n+    print(f\"URL: {request.url}\")\n+    assert request.url == 'http://example.com/?test=foo'\n+    print(\"Success! Params bytes are encoded correctly.\")\n+except Exception as e:\n+    print(f\"Error occurred: {type(e).__name__}: {e}\")\n+\n+# Test with non-ASCII bytes in params\n+print(\"\\nTesting params as bytes with non-ASCII characters:\")\n+try:\n+    # This should probably fail or be encoded properly\n+    request = requests.Request('GET', 'http://example.com', params=b'test=\\xc3\\xb6\\xc3\\xb6\\xc3\\xb6').prepare()\n+    print(f\"URL: {request.url}\")\n+    print(\"Success! No error occurred.\")\n+except Exception as e:\n+    print(f\"Error occurred: {type(e).__name__}: {e}\")\n+\n+# Test with string params\n+print(\"\\nTesting params as string:\")\n+try:\n+    request = requests.Request('GET', 'http://example.com', params='test=foo').prepare()\n+    print(f\"URL: {request.url}\")\n+    assert request.url == 'http://example.com/?test=foo'\n+    print(\"Success! String params work.\")\n+except Exception as e:\n+    print(f\"Error occurred: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_to_native_string.py b/test_to_native_string.py\nnew file mode 100644\nindex 0000000..4a89c31\n--- /dev/null\n+++ b/test_to_native_string.py\n@@ -0,0 +1,26 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import sys\n+sys.path.insert(0, '/testbed')\n+\n+from requests.utils import to_native_string\n+from requests.compat import is_py2, builtin_str\n+\n+print(f\"Python 2: {is_py2}\")\n+print(f\"builtin_str: {builtin_str}\")\n+\n+test_cases = [\n+    (\"ASCII string\", \"hello\"),\n+    (\"Unicode string\", u\"hello\"),\n+    (\"ASCII bytes\", b\"hello\"),\n+    (\"Non-ASCII bytes\", u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\")),\n+    (\"Non-ASCII string\", u\"\u00f6\u00f6\u00f6\"),\n+]\n+\n+for name, value in test_cases:\n+    print(f\"\\nTesting {name}: {repr(value)} (type: {type(value)})\")\n+    try:\n+        result = to_native_string(value)\n+        print(f\"  Result: {repr(result)} (type: {type(result)})\")\n+    except Exception as e:\n+        print(f\"  ERROR: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_try_decode.py b/test_try_decode.py\nnew file mode 100644\nindex 0000000..153bbf8\n--- /dev/null\n+++ b/test_try_decode.py\n@@ -0,0 +1,86 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests.models\n+\n+# Monkey patch _encode_params to try decoding bytes as UTF-8\n+original_encode_params = requests.models.RequestEncodingMixin._encode_params\n+\n+@staticmethod\n+def patched_encode_params(data):\n+    \"\"\"Encode parameters in a piece of data.\n+\n+    Will successfully encode parameters when passed as a dict or a list of\n+    2-tuples. Order is retained if data is a list of 2-tuples but arbitrary\n+    if parameters are supplied as a dict.\n+    \"\"\"\n+    if isinstance(data, bytes):\n+        # Try to decode as UTF-8, but if it fails, return bytes as-is\n+        try:\n+            return data.decode('utf-8')\n+        except UnicodeDecodeError:\n+            # Probably binary data, return as-is\n+            return data\n+    elif isinstance(data, str):\n+        return requests.models.to_native_string(data)\n+    elif hasattr(data, 'read'):\n+        return data\n+    elif hasattr(data, '__iter__'):\n+        result = []\n+        for k, vs in requests.models.to_key_val_list(data):\n+            if isinstance(vs, requests.compat.basestring) or not hasattr(vs, '__iter__'):\n+                vs = [vs]\n+            for v in vs:\n+                if v is not None:\n+                    result.append(\n+                        (k.encode('utf-8') if isinstance(k, str) else k,\n+                         v.encode('utf-8') if isinstance(v, str) else v))\n+        return requests.compat.urlencode(result, doseq=True)\n+    else:\n+        return data\n+\n+requests.models.RequestEncodingMixin._encode_params = patched_encode_params\n+\n+# Now test\n+print(\"Test 1: Binary data in request body (UTF-8 encoded)\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\"))\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 2: Binary data in request body (non-UTF-8)\")\n+try:\n+    # Create some random binary data that's not valid UTF-8\n+    binary_data = bytes([0x80, 0x81, 0x82, 0x83])\n+    response = requests.put(\"http://httpbin.org/put\", data=binary_data)\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 3: Params as bytes\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=foo\")\n+    print(f\"Success! URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 4: Params as bytes with non-ASCII\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=\\xc3\\xb6\\xc3\\xb6\\xc3\\xb6\")\n+    print(f\"Success! URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 5: String data\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=\"hello\")\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 6: Form data as dict\")\n+try:\n+    response = requests.post(\"http://httpbin.org/post\", data={\"key\": \"value\", \"test\": u\"\u00f6\u00f6\u00f6\"})\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\ndiff --git a/test_utf8_fix.py b/test_utf8_fix.py\nnew file mode 100644\nindex 0000000..4066306\n--- /dev/null\n+++ b/test_utf8_fix.py\n@@ -0,0 +1,78 @@\n+#!/usr/bin/env python\n+# -*- coding: utf-8 -*-\n+import requests.models\n+\n+# Monkey patch _encode_params to use utf-8 encoding\n+original_encode_params = requests.models.RequestEncodingMixin._encode_params\n+\n+@staticmethod\n+def patched_encode_params(data):\n+    \"\"\"Encode parameters in a piece of data.\n+\n+    Will successfully encode parameters when passed as a dict or a list of\n+    2-tuples. Order is retained if data is a list of 2-tuples but arbitrary\n+    if parameters are supplied as a dict.\n+    \"\"\"\n+\n+    if isinstance(data, (str, bytes)):\n+        return requests.models.to_native_string(data, 'utf-8')\n+    elif hasattr(data, 'read'):\n+        return data\n+    elif hasattr(data, '__iter__'):\n+        result = []\n+        for k, vs in requests.models.to_key_val_list(data):\n+            if isinstance(vs, requests.compat.basestring) or not hasattr(vs, '__iter__'):\n+                vs = [vs]\n+            for v in vs:\n+                if v is not None:\n+                    result.append(\n+                        (k.encode('utf-8') if isinstance(k, str) else k,\n+                         v.encode('utf-8') if isinstance(v, str) else v))\n+        return requests.compat.urlencode(result, doseq=True)\n+    else:\n+        return data\n+\n+requests.models.RequestEncodingMixin._encode_params = patched_encode_params\n+\n+# Now test\n+print(\"Test 1: Binary data in request body\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\".encode(\"utf-8\"))\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 2: Params as bytes\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=foo\")\n+    print(f\"Success! URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 3: Params as bytes with non-ASCII\")\n+try:\n+    response = requests.get(\"http://httpbin.org/get\", params=b\"test=\\xc3\\xb6\\xc3\\xb6\\xc3\\xb6\")\n+    print(f\"Success! URL: {response.url}\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 4: String data\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=\"hello\")\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 5: Unicode string\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=u\"\u00f6\u00f6\u00f6\")\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n+\n+print(\"\\n\\nTest 6: ASCII-only binary data\")\n+try:\n+    response = requests.put(\"http://httpbin.org/put\", data=b\"hello\")\n+    print(\"Success!\")\n+except Exception as e:\n+    print(f\"Error: {type(e).__name__}: {e}\")\n\\ No newline at end of file\n"}